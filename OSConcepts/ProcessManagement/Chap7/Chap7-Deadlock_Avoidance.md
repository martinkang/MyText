# 교착상태 회피
* 자원이 어떻게 요청될지에 대한 추가 정보를 제공하도록 요구하고, 
이를 바탕으로 각 요청에 대해서 미래의 가능한 교착상태를 피하기 위해서
프로세스의 대기 여부를 결정한다.
	- 위와 같은 결정을 하려면 시스템은 현재 가용 자원, 현재 각 프로세스에 할당된 자원, 
	각 프로세스가 앞으로 요청하거나 방출할 자원을 고려해야 한다.
* 교착상태 회피 알고리즘
	- 시스템에 순환 대기 상황이 발생하지 않도록 동적으로 자원 할당 상태를 검사
	- 자원 할당 상태
		- 가용 자원의 수
		- 할당된 자원의 수 
		- 프로세스들의 최대 요구 개수
	- 이러한 알고리즘은 프로세스가 요청한 자원보다 많은 양을 시스템이 보유하고 있다고 해도
	프로세스가 기다리게 하는 상황이 벌어질 수 있다.
		- 자원 할당 상태를 검사하고, 안전상태가 되도록 프로세스를 기다리게 하기 때문에.
		- 자원의 이용률이 교착상태 회피 알고리즘을 사용하지 않을 때보다 낮아진다.


## 안전 상태
* 시스템 상태가 안전(safe) 하다.
	- 시스템이 어떤 순서로든 프로세스들이 요청하는 모든 자원 ( 최대 요구 개수까지 )을
	교착상태를 야기시키지 않고 차례로 모두 할당해 줄 수 있다는 것을 뜻함
	- 즉 시스템이 안전 순서를 찾을 수 있다면 시스템은 안전하다.
		- < P1, P2, ... Pn > 과 같은 프로세스 순서가 안전하다는 말은 ( 모든 Pi 에 대해 )
	그 Pi 가 요청한 자원을 시스템에 현재 남아 있는 자원과 앞으로 실행을 마칠 모든 프로세스 Pj 들이 ( j < i )
	반납하는 자원들로 만족시켜줄 수 있음을 듯한다.
		- 이와 같은 경우 Pi 가 요청한 자원들을 즉시 만족시켜줄 수 없을 것으로 판단되면 Pi 로 하여금
		Pj 들이 마칠때까지 기다리게 한다.
		- 반대로 모든 프로세스들을 무사히 마칠 수 있는 순서를 찾을 수 없으면 불안전 하다고 한다.
	- 시스템이 안전하다면 교착상태가 아니다.
	- 시스템이 불안전한 상태라면 교착상태가 될 수도 있다.  
	
![deadlock](https://github.com/martinkang/Study/blob/master/OSConcepts/ProcessManagement/img/cahp7-safe.png)


#### 안전, 불안전, 교착상태 예제
* 예제
	- P0
		- 최대 소요량 : 10
		- 현재 사용량 : 5
	- P1
		- 최대 소요량 : 4
		- 현재 사용량 : 2
	- P2
		- 최대 소요량 : 9
		- 현재 사용량 : 2
	- 현재 가용량 3
	- 안전 상태
		- P1 -> P0 -> P2
			- P1 을 가용량 3 중 2 로 끝나면 P1 의 자원이 회수되서 가용량 5 가 됨
			- 가용량 5 를 P0 에 할당하고 P0 가 끝나면 가용량은 10
			- P2 에 할당하고 프로세스 끝
	- 불안전 상태
		- P2 나 P0 에 자원을 할당할 경우 어느것도 끝나지 않고 서로 자원이 할당되기를 기다리므로
		교착상태가 된다.


## 자원 할당 그래프 알고리즘
* 각 자원 타입마다 단지 하나의 인스턴스를 갖는 자원 할당 시스템을 갖고 있을때만 사용 가능한 알고리즘
	- 자원 할당 그래프의 변형을 사용.
		- 예약 간선 ( claim edge ) 를 추가한다.
			- Pi -> Rj 는 Pi 가 미래에 자원 Rj 를 요청할 것이라는 의미이고 점선으로 표시.
		- 프로세스 Pi 가 자원 Rj 를 요청하면, 예약 간선 Pi -> Rj 는 요청 간선으로 변환된다.
		- Pi 가 자원 Rj 를 방출할 때, 할당 간선 Rj -> Pi 는 예약 간선 Pi -> Rj 로 다시 변환된다.
	- 시스템에서 자원이 반드시 미리 예약되어야 한다.
		- 프로세스 Pi 가 실행되기 전에 프로세스의 모든 예약 간선들이 자원 할당 그래프에 표시되어야 한다.
		- 프로세스 Pi 와 연관된 모든 간선들이 예약 간선일 때만 예약 간선 Pi -> Rj 를 그래프에 추가하도록
		허용

		
##### 교착상태 회피를 위한 자원 할당 그래프
![re1](https://github.com/martinkang/Study/blob/master/OSConcepts/ProcessManagement/img/chap7-re1.png)
- 프로세스 Pi 가 자원 Rj 를 요청한다고 할 때, 요청 간선 Pi -> Rj 를 할당 간선 Rj -> Pi 로 변환해도
자원 할당 그래프에 사이클이 형성되지 않을 때만 요청을 허용.
	- 사이클 탐지 알고리즘을 이용해 안전섬을 검사
		- N^2 의 연산을 필요.
	- P2 가 R2 를 요청
		- R2 는 현재 자요 상태이지만 P2 에 할당 불가능.


##### 불안전 상태의 자 할당 그래프
![re2](https://github.com/martinkang/Study/blob/master/OSConcepts/ProcessManagement/img/chap7-re2.png)
- R2 를 P2 에 할당할 경우 다음과 같은 사이클이 생겨 불안전 상태가 된다.
	- 이 때 P1 이 R2 를 요청하면 교착 상태가 발생.



## 은행원 알고리즘

